#include "../local-include/reg.h"
#include <cpu/ifetch.h>
#include <isa-all-instr.h>

def_all_THelper();

static uint32_t get_instr(Decode *s) {
  return s->isa.instr.val;
}

// decode operand helper
#define def_DopHelper(name) \
  void concat(decode_op_, name) (Decode *s, Operand *op, word_t val, bool flag)

static def_DopHelper(i) {
  op->imm = val;
}

static def_DopHelper(r) {
  bool is_write = flag;
  static word_t zero_null = 0;
  op->preg = (is_write && val == 0) ? &zero_null : &gpr(val);
}

static def_DHelper(I) {
  decode_op_r(s, id_src1, s->isa.instr.i.rs1, false);
  decode_op_i(s, id_src2, s->isa.instr.i.simm11_0, false);
  decode_op_r(s, id_dest, s->isa.instr.i.rd, true);
}

static def_DHelper(U) {
  decode_op_i(s, id_src1, s->isa.instr.u.imm31_12 << 12, true);
  decode_op_r(s, id_dest, s->isa.instr.u.rd, true);
}

static def_DHelper(S) {
  decode_op_r(s, id_src1, s->isa.instr.s.rs1, false);
  sword_t simm = (s->isa.instr.s.simm11_5 << 5) | s->isa.instr.s.imm4_0;
  decode_op_i(s, id_src2, simm, false);
  decode_op_r(s, id_dest, s->isa.instr.s.rs2, false);
}

// my DHelper for UJ
static def_DHelper(UJ) {
	*t0 = (s->isa.instr.uj.imm20 << 20) | (s->isa.instr.uj.imm19_12 << 12) |
				(s->isa.instr.uj.imm11 << 11) | (s->isa.instr.uj.imm10_1 << 1);
	*t0 = (int32_t)(*t0 << 11) >> 11;
	decode_op_i(s, id_src1, *t0, false);
	decode_op_r(s, id_dest, s->isa.instr.uj.rd, true);
}

// my DHelper for R
static def_DHelper(R) {
  decode_op_r(s, id_src1, s->isa.instr.r.rs1, false);
  decode_op_r(s, id_src2, s->isa.instr.r.rs2, false);
  decode_op_r(s, id_dest, s->isa.instr.r.rd, true);
}

// my DHelper for SB
static def_DHelper(SB) {
	*t0 = (s->isa.instr.sb.imm12 << 12) | (s->isa.instr.sb.imm10_5 << 5) |
				(s->isa.instr.sb.imm11 << 11) | (s->isa.instr.sb.imm4_1 << 1);
	*t0 = (uint32_t)((int32_t)(*t0 << 19) >> 19);
	decode_op_i(s, id_dest, *t0, false);
	decode_op_r(s, id_src1, s->isa.instr.sb.rs1, false);
	decode_op_r(s, id_src2, s->isa.instr.sb.rs2, false);
}

def_THelper(load) {
	def_INSTR_TAB("??????? ????? ????? 000 ????? ????? ??", lb);	// my lb
	def_INSTR_TAB("??????? ????? ????? 001 ????? ????? ??", lh);	// my lh
  def_INSTR_TAB("??????? ????? ????? 010 ????? ????? ??", lw);
  def_INSTR_TAB("??????? ????? ????? 100 ????? ????? ??", lbu);		// my Thelper for lbu
  def_INSTR_TAB("??????? ????? ????? 101 ????? ????? ??", lhu);	// my lhu
  return EXEC_ID_inv;
}

def_THelper(store) {
	def_INSTR_TAB("??????? ????? ????? 000 ????? ????? ??", sb);
  def_INSTR_TAB("??????? ????? ????? 010 ????? ????? ??", sw);
  def_INSTR_TAB("??????? ????? ????? 001 ????? ????? ??", sh);
  return EXEC_ID_inv;
}

// my THelper for cacui
def_THelper(cacui) {
	def_INSTR_TAB("??????? ????? ????? 000 ????? ????? ??", addi);
	def_INSTR_TAB("??????? ????? ????? 001 ????? ????? ??", slli);
	def_INSTR_TAB("??????? ????? ????? 010 ????? ????? ??", slti);
	def_INSTR_TAB("??????? ????? ????? 011 ????? ????? ??", sltiu);
	def_INSTR_TAB("??????? ????? ????? 100 ????? ????? ??", xori);
	def_INSTR_TAB("??????? ????? ????? 101 ????? ????? ??", srli_srai);
	def_INSTR_TAB("??????? ????? ????? 110 ????? ????? ??", ori);
	def_INSTR_TAB("??????? ????? ????? 111 ????? ????? ??", andi);
	return EXEC_ID_inv;
}

// my THelper for sys
def_THelper(sys) {
	def_INSTR_TAB("??????? ????? ????? 000 ????? ????? ??", ecall_ebreak);
	def_INSTR_TAB("??????? ????? ????? 001 ????? ????? ??", csrrw);
	def_INSTR_TAB("??????? ????? ????? 010 ????? ????? ??", csrrs);
	return EXEC_ID_inv;
}

// my THelper for R-type
def_THelper(cacu) {
	def_INSTR_TAB("??????? ????? ????? 000 ????? ????? ??", add_sub_mul);
	def_INSTR_TAB("??????? ????? ????? 001 ????? ????? ??", sll_mulh);
	def_INSTR_TAB("??????? ????? ????? 010 ????? ????? ??", slt_mulhsu);
	def_INSTR_TAB("??????? ????? ????? 011 ????? ????? ??", sltu_mulhu);
	def_INSTR_TAB("??????? ????? ????? 100 ????? ????? ??", xor_div);
	def_INSTR_TAB("??????? ????? ????? 101 ????? ????? ??", srl_sra_divu);
	def_INSTR_TAB("??????? ????? ????? 110 ????? ????? ??", or_rem);
	def_INSTR_TAB("??????? ????? ????? 111 ????? ????? ??", and_remu);
	return EXEC_ID_inv;
}

// my THelper for SB-type
def_THelper(branch) {
	def_INSTR_TAB("??????? ????? ????? 000 ????? ????? ??", beq);
	def_INSTR_TAB("??????? ????? ????? 001 ????? ????? ??", bne);
	def_INSTR_TAB("??????? ????? ????? 100 ????? ????? ??", blt);
	def_INSTR_TAB("??????? ????? ????? 101 ????? ????? ??", bge);
	def_INSTR_TAB("??????? ????? ????? 110 ????? ????? ??", bltu);
	def_INSTR_TAB("??????? ????? ????? 111 ????? ????? ??", bgeu);
	return EXEC_ID_inv;
}

def_THelper(main) {
  def_INSTR_IDTAB("??????? ????? ????? ??? ????? 00000 11", I     , load);
  def_INSTR_IDTAB("??????? ????? ????? ??? ????? 00100 11", I     , cacui);		// my cacui
  def_INSTR_IDTAB("??????? ????? ????? ??? ????? 11001 11", I     , jalr);		// my jalr
  def_INSTR_IDTAB("??????? ????? ????? ??? ????? 11100 11", I			, sys);			// my sys
  def_INSTR_IDTAB("??????? ????? ????? ??? ????? 01000 11", S     , store);
  def_INSTR_IDTAB("??????? ????? ????? ??? ????? 01100 11", R     , cacu);		// my R-type
  def_INSTR_IDTAB("??????? ????? ????? ??? ????? 01101 11", U     , lui);		
  def_INSTR_IDTAB("??????? ????? ????? ??? ????? 00101 11", U     , auipc);		// my auipc
  def_INSTR_IDTAB("??????? ????? ????? ??? ????? 11011 11", UJ    , jal);			// my jal
  def_INSTR_IDTAB("??????? ????? ????? ??? ????? 11000 11", SB    , branch);  // my branch
  def_INSTR_TAB  ("??????? ????? ????? ??? ????? 11010 11",         nemu_trap);
  return table_inv(s);
};

int isa_fetch_decode(Decode *s) {
  s->isa.instr.val = instr_fetch(&s->snpc, 4);
  int idx = table_main(s);
  return idx;
}
